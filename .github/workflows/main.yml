name: Build Coccinelle Portable

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    container: ubuntu:18.04
    
    steps:
    - name: Install and package Coccinelle
      run: |
        # è¨­ç½®éäº¤äº’å¼æ¨¡å¼
        export DEBIAN_FRONTEND=noninteractive
        
        # æ›´æ–°ä¸¦å®‰è£ Coccinelle
        apt-get update -qq
        apt-get install -y -qq coccinelle tar
        
        # æª¢æŸ¥å®‰è£
        echo "Checking Coccinelle installation..."
        which spatch
        spatch --version
        
        # å‰µå»ºå¯æ”œå¼åŒ…ç›®éŒ„çµæ§‹
        mkdir -p portable-coccinelle/bin
        mkdir -p portable-coccinelle/lib
        mkdir -p portable-coccinelle/share
        
        # è¤‡è£½ spatch åŸ·è¡Œæª”
        cp /usr/bin/spatch portable-coccinelle/bin/
        
        # è¤‡è£½ OCaml åº«æ–‡ä»¶
        if [ -d /usr/lib/x86_64-linux-gnu/ocaml ]; then
            cp -r /usr/lib/x86_64-linux-gnu/ocaml portable-coccinelle/lib/
        fi
        
        # è¤‡è£½ Coccinelle é…ç½®å’Œè…³æœ¬
        if [ -d /usr/share/coccinelle ]; then
            cp -r /usr/share/coccinelle portable-coccinelle/share/
        fi
        
        # è¤‡è£½å…¶ä»–å¯èƒ½éœ€è¦çš„åº«
        if [ -d /usr/lib/ocaml ]; then
            cp -r /usr/lib/ocaml portable-coccinelle/lib/ 2>/dev/null || true
        fi
        
        # å‰µå»ºå•Ÿå‹•è…³æœ¬
        cat > portable-coccinelle/spatch.sh << 'EOF'
        #!/bin/bash
        # Portable Coccinelle launcher script
        SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )"
        
        # è¨­ç½®ç’°å¢ƒè®Šæ•¸
        export LD_LIBRARY_PATH="$SCRIPT_DIR/lib:$SCRIPT_DIR/lib/x86_64-linux-gnu:$LD_LIBRARY_PATH"
        export OCAML_TOPLEVEL_PATH="$SCRIPT_DIR/lib/ocaml"
        export COCCINELLE_HOME="$SCRIPT_DIR/share/coccinelle"
        
        # åŸ·è¡Œ spatch
        "$SCRIPT_DIR/bin/spatch" "$@"
        EOF
        
        # è¨­ç½®åŸ·è¡Œæ¬Šé™
        chmod +x portable-coccinelle/spatch.sh
        chmod +x portable-coccinelle/bin/spatch
        
        # å‰µå»º README æ–‡ä»¶
        cat > portable-coccinelle/README.md << 'EOF'
        # Portable Coccinelle Package
        
        This is a portable version of Coccinelle (spatch) built for Ubuntu systems.
        
        ## Usage
        
        ### Method 1: Use the launcher script
        ```bash
        ./spatch.sh --version
        ./spatch.sh [your-options] [files]
        ```
        
        ### Method 2: Add to PATH
        ```bash
        export PATH=$PWD:$PATH
        spatch.sh --version
        ```
        
        ### Method 3: Create alias
        ```bash
        alias spatch=$PWD/spatch.sh
        spatch --version
        ```
        
        ## Installation
        
        1. Extract the package:
           ```bash
           tar -xzf coccinelle-portable.tar.gz
           cd portable-coccinelle
           ```
        
        2. Test the installation:
           ```bash
           ./spatch.sh --version
           ```
        
        3. (Optional) Add to your shell profile:
           ```bash
           echo "export PATH=\$PATH:$(pwd)" >> ~/.bashrc
           echo "alias spatch=$(pwd)/spatch.sh" >> ~/.bashrc
           source ~/.bashrc
           ```
        
        ## Package Info
        
        - Coccinelle Version: Built from Ubuntu 18.04 repository
        - Build Date: $(date)
        - Includes: Python support, PCRE support
        - Compatibility: Ubuntu 16.04+ and compatible Linux distributions
        EOF
        
        # æ¸¬è©¦å¯æ”œå¼ç‰ˆæœ¬
        echo "Testing portable spatch..."
        ./portable-coccinelle/spatch.sh --version
        
        # é¡¯ç¤ºåŒ…å…§å®¹
        echo "Package contents:"
        find portable-coccinelle -type f | head -20
        
        # æ‰“åŒ…
        tar -czf coccinelle-portable.tar.gz portable-coccinelle/
        
        # é¡¯ç¤ºæœ€çµ‚ä¿¡æ¯
        echo "========================================="
        echo "âœ… Coccinelle portable package created!"
        echo "ğŸ“¦ Package: coccinelle-portable.tar.gz"
        echo "ğŸ“ Size: $(du -h coccinelle-portable.tar.gz | cut -f1)"
        echo "ğŸ“ Location: $(pwd)/coccinelle-portable.tar.gz"
        echo "========================================="
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: coccinelle-portable
        path: coccinelle-portable.tar.gz
        retention-days: 30
    
    - name: Display download instructions
      run: |
        echo "ğŸ‰ Build completed successfully!"
        echo ""
        echo "ğŸ“¥ To download your package:"
        echo "1. Go to the Actions tab in your GitHub repository"
        echo "2. Click on this workflow run"
        echo "3. Scroll down to the 'Artifacts' section"
        echo "4. Click 'coccinelle-portable' to download"
        echo ""
        echo "ğŸ“‹ Package contents:"
        echo "- spatch.sh (launcher script)"
        echo "- bin/spatch (main executable)"
        echo "- lib/ (OCaml libraries)"
        echo "- share/ (Coccinelle configuration)"
        echo "- README.md (usage instructions)"
