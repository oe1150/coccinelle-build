name: Build Coccinelle Simple

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    container: ubuntu:18.04
    
    steps:
    - name: Install and package Coccinelle
      run: |
        # 設置非交互式模式
        export DEBIAN_FRONTEND=noninteractive
        
        # 更新並安裝 Coccinelle
        apt-get update -qq
        apt-get install -y -qq coccinelle curl tar
        
        # 檢查安裝
        which spatch
        spatch --version
        
        # 創建可攜式包
        mkdir -p portable-coccinelle/bin
        mkdir -p portable-coccinelle/lib
        mkdir -p portable-coccinelle/share
        
        # 複製 spatch 和相關文件
        cp /usr/bin/spatch portable-coccinelle/bin/
        
        # 複製庫文件
        cp -r /usr/lib/x86_64-linux-gnu/ocaml portable-coccinelle/lib/ 2>/dev/null || true
        cp -r /usr/share/coccinelle portable-coccinelle/share/ 2>/dev/null || true
        
        # 創建啟動腳本
        cat > portable-coccinelle/spatch.sh << 'EOF'
        #!/bin/bash
        SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )"
        export LD_LIBRARY_PATH="$SCRIPT_DIR/lib:$LD_LIBRARY_PATH"
        export OCAML_TOPLEVEL_PATH="$SCRIPT_DIR/lib/ocaml"
        "$SCRIPT_DIR/bin/spatch" "$@"
        EOF
        chmod +x portable-coccinelle/spatch.sh
        
        # 測試
        echo "Testing portable spatch..."
        ./portable-coccinelle/spatch.sh --version
        
        # 打包
        tar -czf coccinelle-portable.tar.gz portable-coccinelle/
        
        # 上傳到 transfer.sh
        echo "Uploading to transfer.sh..."
        URL=$(curl --upload-file coccinelle-portable.tar.gz https://transfer.sh/coccinelle-portable.tar.gz)
        echo "========================================="
        echo "DOWNLOAD URL: $URL"
        echo "========================================="
        
        # 顯示文件信息
        echo "Package size: $(du -h coccinelle-portable.tar.gz | cut -f1)"
        echo "Package location: $(pwd)/coccinelle-portable.tar.gz"
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: coccinelle-portable
        path: coccinelle-portable.tar.gz
      continue-on-error: true
