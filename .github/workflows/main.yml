name: Build and Release Coccinelle

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    container: ubuntu:18.04
    
    steps:
    - name: Build Coccinelle package
      run: |
        export DEBIAN_FRONTEND=noninteractive
        apt-get update -qq
        apt-get install -y -qq coccinelle tar curl ca-certificates
        
        echo "Building Coccinelle $(spatch --version | head -1)"
        
        rm -rf portable-coccinelle
        mkdir -p portable-coccinelle/bin
        mkdir -p portable-coccinelle/lib  
        mkdir -p portable-coccinelle/share
        
        cp /usr/bin/spatch portable-coccinelle/bin/
        
        if [ -d /usr/lib/x86_64-linux-gnu/ocaml ]; then
            cp -r /usr/lib/x86_64-linux-gnu/ocaml portable-coccinelle/lib/
        fi
        
        if [ -d /usr/share/coccinelle ]; then
            cp -r /usr/share/coccinelle portable-coccinelle/share/
        fi
        
        echo '#!/bin/bash' > portable-coccinelle/spatch.sh
        echo 'SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )"' >> portable-coccinelle/spatch.sh
        echo 'export LD_LIBRARY_PATH="$SCRIPT_DIR/lib:$SCRIPT_DIR/lib/x86_64-linux-gnu:$LD_LIBRARY_PATH"' >> portable-coccinelle/spatch.sh
        echo 'export OCAML_TOPLEVEL_PATH="$SCRIPT_DIR/lib/ocaml"' >> portable-coccinelle/spatch.sh
        echo 'export COCCINELLE_HOME="$SCRIPT_DIR/share/coccinelle"' >> portable-coccinelle/spatch.sh
        echo '"$SCRIPT_DIR/bin/spatch" "$@"' >> portable-coccinelle/spatch.sh
        
        chmod +x portable-coccinelle/spatch.sh
        chmod +x portable-coccinelle/bin/spatch
        
        echo "# Portable Coccinelle" > portable-coccinelle/README.md
        echo "" >> portable-coccinelle/README.md
        echo "## Usage" >> portable-coccinelle/README.md
        echo "./spatch.sh --version" >> portable-coccinelle/README.md
        echo "./spatch.sh script.cocci file.c" >> portable-coccinelle/README.md
        
        echo "Testing portable spatch..."
        ./portable-coccinelle/spatch.sh --version
        
        tar -czf coccinelle-portable.tar.gz portable-coccinelle/
        echo "Package size: $(du -h coccinelle-portable.tar.gz | cut -f1)"

    - name: Create Release
      run: |
        RELEASE_TAG="coccinelle-$(date +%Y%m%d-%H%M%S)"
        RELEASE_NAME="Coccinelle Portable $(date +%Y-%m-%d)"
        
        echo "Creating release: $RELEASE_TAG"
        
        echo "{" > payload.json
        echo "  \"tag_name\": \"$RELEASE_TAG\"," >> payload.json
        echo "  \"target_commitish\": \"main\"," >> payload.json
        echo "  \"name\": \"$RELEASE_NAME\"," >> payload.json
        echo "  \"body\": \"Portable Coccinelle package built from Ubuntu 18.04. Extract and run ./spatch.sh --version\"," >> payload.json
        echo "  \"draft\": false," >> payload.json
        echo "  \"prerelease\": false" >> payload.json
        echo "}" >> payload.json
        
        echo "JSON payload:"
        cat payload.json
        
        RELEASE_RESPONSE=$(curl -s -X POST \
          -H "Authorization: token $GITHUB_TOKEN" \
          -H "Content-Type: application/json" \
          "https://api.github.com/repos/$GITHUB_REPOSITORY/releases" \
          -d @payload.json)
        
        echo "Release response:"
        echo "$RELEASE_RESPONSE"
        
        UPLOAD_URL=$(echo "$RELEASE_RESPONSE" | grep -o '"upload_url": "[^"]*' | cut -d'"' -f4 | sed 's/{?name,label}//')
        RELEASE_HTML_URL=$(echo "$RELEASE_RESPONSE" | grep -o '"html_url": "[^"]*' | cut -d'"' -f4)
        
        if [ -z "$UPLOAD_URL" ]; then
          echo "Failed to create release"
          exit 1
        fi
        
        echo "Release created: $RELEASE_HTML_URL"
        echo "Uploading file..."
        
        UPLOAD_RESPONSE=$(curl -s -X POST \
          -H "Authorization: token $GITHUB_TOKEN" \
          -H "Content-Type: application/gzip" \
          --data-binary @coccinelle-portable.tar.gz \
          "${UPLOAD_URL}?name=coccinelle-portable.tar.gz")
        
        DOWNLOAD_URL=$(echo "$UPLOAD_RESPONSE" | grep -o '"browser_download_url": "[^"]*' | cut -d'"' -f4)
        
        echo "========================================="
        echo "SUCCESS!"
        echo "========================================="
        echo "Release Page: $RELEASE_HTML_URL"
        if [ -n "$DOWNLOAD_URL" ]; then
          echo "Download URL: $DOWNLOAD_URL"
        fi
        echo "Tag: $RELEASE_TAG"
        echo "========================================="
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
