name: Build and Release Coccinelle

on:
  workflow_dispatch:

permissions:
  contents: write
  
jobs:
  build:
    runs-on: ubuntu-22.04
    container: ubuntu:18.04
    
    steps:
    - name: Build Coccinelle package
      run: |
        export DEBIAN_FRONTEND=noninteractive
        apt-get update -qq
        apt-get install -y -qq coccinelle tar curl ca-certificates
        
        echo "Building Coccinelle $(spatch --version | head -1)"
        
        # 檢查 spatch 安裝位置
        echo "Checking spatch installation..."
        which spatch
        file $(which spatch)
        
        # 檢查系統中的 coccinelle 文件
        echo "System coccinelle files:"
        find /usr -name "*coccinelle*" -o -name "*spatch*" 2>/dev/null | head -10
        
        # 檢查 OCaml 文件
        echo "OCaml files:"
        find /usr -name "*ocaml*" -type d 2>/dev/null | head -5
        
        rm -rf portable-coccinelle
        mkdir -p portable-coccinelle/bin
        mkdir -p portable-coccinelle/lib  
        mkdir -p portable-coccinelle/share
        mkdir -p portable-coccinelle/usr-lib-coccinelle
        
        # 複製 spatch 腳本
        cp /usr/bin/spatch portable-coccinelle/bin/
        echo "Copied spatch from /usr/bin/"
        
        # 尋找並複製實際的 coccinelle 文件
        echo "Looking for coccinelle library files..."
        if [ -d /usr/lib/coccinelle ]; then
            cp -r /usr/lib/coccinelle/* portable-coccinelle/usr-lib-coccinelle/
            echo "Copied from /usr/lib/coccinelle/"
            ls -la /usr/lib/coccinelle/ | head -5
        else
            echo "No /usr/lib/coccinelle found"
        fi
        
        # 複製 OCaml 庫
        echo "Looking for OCaml libraries..."
        for ocaml_dir in /usr/lib/ocaml /usr/lib/x86_64-linux-gnu/ocaml; do
            if [ -d "$ocaml_dir" ]; then
                mkdir -p portable-coccinelle/lib/$(basename $ocaml_dir)
                cp -r "$ocaml_dir"/* portable-coccinelle/lib/$(basename $ocaml_dir)/ 2>/dev/null || true
                echo "Copied OCaml from $ocaml_dir"
                ls -la "$ocaml_dir" | head -3
            fi
        done
        
        # 複製 share 文件
        echo "Looking for share files..."
        if [ -d /usr/share/coccinelle ]; then
            cp -r /usr/share/coccinelle portable-coccinelle/share/
            echo "Copied from /usr/share/coccinelle/"
            ls -la /usr/share/coccinelle/ | head -5
        else
            echo "No /usr/share/coccinelle found"
        fi
        
        # 複製 Python 模組
        if [ -d /usr/lib/python*/dist-packages/coccinelle ]; then
            mkdir -p portable-coccinelle/python
            cp -r /usr/lib/python*/dist-packages/coccinelle portable-coccinelle/python/ 2>/dev/null || true
            echo "Copied Python modules"
        fi
        
        # 創建修復的 spatch 腳本
        echo "Creating fixed spatch script..."
        echo '#!/bin/bash' > portable-coccinelle/bin/spatch.fixed
        echo 'SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )"' >> portable-coccinelle/bin/spatch.fixed
        echo 'COCCINELLE_ROOT="$(dirname "$SCRIPT_DIR")"' >> portable-coccinelle/bin/spatch.fixed
        echo '' >> portable-coccinelle/bin/spatch.fixed
        echo '# 設置環境變數' >> portable-coccinelle/bin/spatch.fixed
        echo 'export LD_LIBRARY_PATH="$COCCINELLE_ROOT/lib:$COCCINELLE_ROOT/lib/ocaml:$LD_LIBRARY_PATH"' >> portable-coccinelle/bin/spatch.fixed
        echo 'export OCAML_TOPLEVEL_PATH="$COCCINELLE_ROOT/lib/ocaml"' >> portable-coccinelle/bin/spatch.fixed
        echo 'export PYTHONPATH="${PYTHONPATH:+$PYTHONPATH:}$COCCINELLE_ROOT/python:$COCCINELLE_ROOT/usr-lib-coccinelle/python"' >> portable-coccinelle/bin/spatch.fixed
        echo '' >> portable-coccinelle/bin/spatch.fixed
        echo '# 尋找實際的 spatch 可執行文件' >> portable-coccinelle/bin/spatch.fixed
        echo 'for spatch_bin in \' >> portable-coccinelle/bin/spatch.fixed
        echo '    "$COCCINELLE_ROOT/usr-lib-coccinelle/spatch" \' >> portable-coccinelle/bin/spatch.fixed
        echo '    "$COCCINELLE_ROOT/share/coccinelle/spatch" \' >> portable-coccinelle/bin/spatch.fixed
        echo '    "$COCCINELLE_ROOT/usr-lib-coccinelle/spatch.opt" \' >> portable-coccinelle/bin/spatch.fixed
        echo '    ; do' >> portable-coccinelle/bin/spatch.fixed
        echo '    if [ -x "$spatch_bin" ]; then' >> portable-coccinelle/bin/spatch.fixed
        echo '        exec "$spatch_bin" "$@"' >> portable-coccinelle/bin/spatch.fixed
        echo '    fi' >> portable-coccinelle/bin/spatch.fixed
        echo 'done' >> portable-coccinelle/bin/spatch.fixed
        echo '' >> portable-coccinelle/bin/spatch.fixed
        echo 'echo "Error: Cannot find spatch executable"' >> portable-coccinelle/bin/spatch.fixed
        echo 'echo "Available files:"' >> portable-coccinelle/bin/spatch.fixed
        echo 'find "$COCCINELLE_ROOT" -name "*spatch*" -type f' >> portable-coccinelle/bin/spatch.fixed
        echo 'exit 1' >> portable-coccinelle/bin/spatch.fixed
        
        chmod +x portable-coccinelle/bin/spatch.fixed
        
        # 創建主啟動腳本
        echo "Creating main launcher script..."
        echo '#!/bin/bash' > portable-coccinelle/spatch.sh
        echo 'SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )"' >> portable-coccinelle/spatch.sh
        echo 'export LD_LIBRARY_PATH="$SCRIPT_DIR/lib:$SCRIPT_DIR/lib/ocaml:$LD_LIBRARY_PATH"' >> portable-coccinelle/spatch.sh
        echo 'export OCAML_TOPLEVEL_PATH="$SCRIPT_DIR/lib/ocaml"' >> portable-coccinelle/spatch.sh
        echo 'export PYTHONPATH="${PYTHONPATH:+$PYTHONPATH:}$SCRIPT_DIR/python:$SCRIPT_DIR/usr-lib-coccinelle/python"' >> portable-coccinelle/spatch.sh
        echo '' >> portable-coccinelle/spatch.sh
        echo '# 嘗試使用修復的 spatch' >> portable-coccinelle/spatch.sh
        echo 'if [ -x "$SCRIPT_DIR/bin/spatch.fixed" ]; then' >> portable-coccinelle/spatch.sh
        echo '    "$SCRIPT_DIR/bin/spatch.fixed" "$@"' >> portable-coccinelle/spatch.sh
        echo 'else' >> portable-coccinelle/spatch.sh
        echo '    echo "Error: spatch.fixed not found"' >> portable-coccinelle/spatch.sh
        echo '    exit 1' >> portable-coccinelle/spatch.sh
        echo 'fi' >> portable-coccinelle/spatch.sh
        
        chmod +x portable-coccinelle/spatch.sh
        
        echo "Package contents:"
        find portable-coccinelle -type f | head -20
        
        echo "Testing portable spatch..."
        ./portable-coccinelle/spatch.sh --version || echo "Test failed, but package created"
        
        tar -czf coccinelle-portable.tar.gz portable-coccinelle/
        echo "Package size: $(du -h coccinelle-portable.tar.gz | cut -f1)"

    - name: Create Release
      run: |
        RELEASE_TAG="coccinelle-$(date +%Y%m%d-%H%M%S)"
        RELEASE_NAME="Coccinelle Portable $(date +%Y-%m-%d)"
        
        echo "Creating release: $RELEASE_TAG"
        echo "Repository: $GITHUB_REPOSITORY"
        echo "Token length: ${#GITHUB_TOKEN}"
        
        echo "{" > payload.json
        echo "  \"tag_name\": \"$RELEASE_TAG\"," >> payload.json
        echo "  \"target_commitish\": \"main\"," >> payload.json
        echo "  \"name\": \"$RELEASE_NAME\"," >> payload.json
        echo "  \"body\": \"Portable Coccinelle package built from Ubuntu 18.04. Extract and run ./spatch.sh --version\"," >> payload.json
        echo "  \"draft\": false," >> payload.json
        echo "  \"prerelease\": false" >> payload.json
        echo "}" >> payload.json
        
        echo "JSON payload:"
        cat payload.json
        
        RELEASE_RESPONSE=$(curl -s -w "HTTP_CODE:%{http_code}" -X POST \
          -H "Authorization: token $GITHUB_TOKEN" \
          -H "Content-Type: application/json" \
          -H "Accept: application/vnd.github.v3+json" \
          "https://api.github.com/repos/$GITHUB_REPOSITORY/releases" \
          -d @payload.json)
        
        echo "Release response:"
        echo "$RELEASE_RESPONSE"
        
        HTTP_CODE=$(echo "$RELEASE_RESPONSE" | grep -o "HTTP_CODE:[0-9]*" | cut -d: -f2)
        RESPONSE_BODY=$(echo "$RELEASE_RESPONSE" | sed 's/HTTP_CODE:[0-9]*$//')
        
        if [ "$HTTP_CODE" = "201" ]; then
          echo "Release created successfully!"
          
          UPLOAD_URL=$(echo "$RESPONSE_BODY" | grep -o '"upload_url": "[^"]*' | cut -d'"' -f4 | sed 's/{?name,label}//')
          RELEASE_HTML_URL=$(echo "$RESPONSE_BODY" | grep -o '"html_url": "[^"]*' | cut -d'"' -f4)
          
          echo "Release created: $RELEASE_HTML_URL"
          echo "Uploading file..."
          
          UPLOAD_RESPONSE=$(curl -s -X POST \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Content-Type: application/gzip" \
            --data-binary @coccinelle-portable.tar.gz \
            "${UPLOAD_URL}?name=coccinelle-portable.tar.gz")
          
          DOWNLOAD_URL=$(echo "$UPLOAD_RESPONSE" | grep -o '"browser_download_url": "[^"]*' | cut -d'"' -f4)
          
          echo "========================================="
          echo "SUCCESS!"
          echo "========================================="
          echo "Release Page: $RELEASE_HTML_URL"
          if [ -n "$DOWNLOAD_URL" ]; then
            echo "Download URL: $DOWNLOAD_URL"
          fi
          echo "Tag: $RELEASE_TAG"
          echo "========================================="
        else
          echo "Failed to create release (HTTP $HTTP_CODE)"
          
          if [ "$HTTP_CODE" = "403" ]; then
            echo ""
            echo "ALTERNATIVE: Manual upload instructions"
            echo "========================================="
            echo "Since release creation failed, you can manually create one:"
            echo "1. Go to: https://github.com/$GITHUB_REPOSITORY/releases/new"
            echo "2. Tag: $RELEASE_TAG"
            echo "3. Title: $RELEASE_NAME"
            echo "4. Upload the file: coccinelle-portable.tar.gz ($(du -h coccinelle-portable.tar.gz | cut -f1))"
            echo ""
            echo "OR use file sharing services:"
            echo "Trying alternative upload..."
            
            for service in "https://file.io" "https://0x0.st"; do
              echo "Trying $service..."
              UPLOAD_RESULT=$(curl -s --connect-timeout 10 -F "file=@coccinelle-portable.tar.gz" "$service" 2>/dev/null || echo "failed")
              if echo "$UPLOAD_RESULT" | grep -q "http"; then
                echo "SUCCESS: $UPLOAD_RESULT"
                break
              fi
            done
          fi
          
          exit 1
        fi
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
