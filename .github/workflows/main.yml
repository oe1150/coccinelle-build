name: Build Static Coccinelle (GLIBC 2.23 Compatible)

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Build Static Coccinelle in Docker (Ubuntu 16.04)
      run: |
        docker run --rm -v ${{ github.workspace }}:/output ubuntu:16.04 bash -c '
          set -e
          apt-get update && apt-get install -y \
            build-essential ocaml ocaml-native-compilers ocaml-findlib \
            libnum-ocaml-dev libpcre3-dev libpcre-ocaml-dev pkg-config \
            python3-dev autoconf automake libtool m4 wget curl ca-certificates

          cd /tmp
          VERSION="1.0.7"
          wget https://github.com/coccinelle/coccinelle/archive/refs/tags/$VERSION.tar.gz
          tar -xzf $VERSION.tar.gz
          cd coccinelle-$VERSION

          autoreconf -fiv
          ./configure --prefix=/output/cocci-out --disable-python
          make -j$(nproc)
          make install

          cd /output
          tar -czf coccinelle-$VERSION-static-ubuntu16.tar.gz cocci-out
        '

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: coccinelle-static
        path: coccinelle-*-static-ubuntu16.tar.gz
