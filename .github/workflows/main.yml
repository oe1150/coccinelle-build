name: Build Static Spatch 1.0.7 (GLIBC 2.23 Compatible)

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build Spatch in Docker (Debian Jessie)
        run: |
          echo "=== Building static spatch in Debian Jessie ==="
          mkdir -p output

          cat > Dockerfile <<'EOF'
          FROM debian:jessie
          RUN apt-get update && apt-get install -y \
            build-essential \
            ocaml \
            ocaml-findlib \
            ocaml-native-compilers \
            libpcre3-dev \
            pkg-config \
            autoconf \
            automake \
            libtool \
            m4 \
            curl \
            wget \
            ca-certificates

          WORKDIR /src
          RUN wget https://github.com/coccinelle/coccinelle/archive/refs/tags/1.0.7.tar.gz && \
              tar -xzf 1.0.7.tar.gz && cd coccinelle-1.0.7 && \
              ./autogen && \
              ./configure --prefix=/opt/spatch --disable-python --disable-pcre && \
              make -j1 && make install

          RUN cd /opt && \
              tar -czf /src/spatch-1.0.7-static.tar.gz spatch
          EOF

          docker build -t spatch-builder .
          docker create --name extract spatch-builder
          docker cp extract:/src/spatch-1.0.7-static.tar.gz ./output/
          docker rm extract

      - name: Upload Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: spatch-1.0.7-static
          name: Static Spatch 1.0.7 (GLIBC 2.23 Compatible)
          files: output/spatch-1.0.7-static.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
