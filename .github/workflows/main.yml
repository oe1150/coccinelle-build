name: Build Static Coccinelle 1.0.7+ (GLIBC 2.23 Compatible)

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Build Static Coccinelle in Ubuntu 16.04
      run: |
        echo "Building static Coccinelle for GLIBC 2.23 compatibility"

        docker pull ubuntu:16.04

        cat > build_static.sh << 'EOF'
#!/bin/bash
set -e

# Fix APT sources since Xenial is EOL
cat > /etc/apt/sources.list <<EOF2
deb http://archive.ubuntu.com/ubuntu xenial main restricted universe multiverse
deb http://archive.ubuntu.com/ubuntu xenial-updates main restricted universe multiverse
deb http://archive.ubuntu.com/ubuntu xenial-security main restricted universe multiverse
EOF2

apt-get update
apt-get install -y \
  build-essential \
  ocaml \
  ocaml-native-compilers \
  ocaml-findlib \
  libnum-ocaml-dev \
  libpcre3-dev \
  libpcre-ocaml-dev \
  pkg-config \
  python3-dev \
  autoconf \
  automake \
  libtool \
  m4 \
  wget \
  curl \
  ca-certificates \
  musl-dev \
  musl-tools

cd /tmp

for VERSION in "1.0.7" "1.0.6"; do
  wget -q https://github.com/coccinelle/coccinelle/archive/refs/tags/$VERSION.tar.gz
  tar -xzf $VERSION.tar.gz
  cd coccinelle-$VERSION

  autoreconf -fiv || true

  ./configure \
    --prefix=/opt/static-spatch \
    --disable-opt \
    --disable-pcre \
    --disable-python \
    --disable-shared \
    --enable-static \
    CC="gcc -static" \
    LDFLAGS="-static" \
    OCAMLC_OPT="-ccopt -static" \
    OCAMLOPT_OPT="-ccopt -static" || true

  make -j1 LDFLAGS="-static" || true

  for spatch_name in spatch spatch.opt spatch.byte; do
    if [ -f "$spatch_name" ]; then
      cp "$spatch_name" spatch
      chmod +x spatch
      mkdir -p /opt/static-spatch/bin
      cp spatch /opt/static-spatch/bin/
      echo "$VERSION" > /tmp/SUCCESS_VERSION
      break
    fi
  done

  [ -f /tmp/SUCCESS_VERSION ] && break
  cd /tmp

done

if [ ! -f /tmp/SUCCESS_VERSION ]; then
  echo "‚ùå Build failed"
  exit 1
fi

cd /opt
mkdir -p portable-coccinelle/bin
cp static-spatch/bin/spatch portable-coccinelle/bin/
chmod +x portable-coccinelle/bin/spatch

cd /opt
VERSION=$(cat /tmp/SUCCESS_VERSION)
tar -czf coccinelle-${VERSION}-static-ubuntu16.tar.gz portable-coccinelle/
cp coccinelle-${VERSION}-static-ubuntu16.tar.gz /output/
EOF

        docker run --rm \
          -v $(pwd)/build_static.sh:/build_static.sh \
          -v $(pwd):/output \
          ubuntu:16.04 \
          bash -c "chmod +x /build_static.sh && /build_static.sh"

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: static-coccinelle
        path: coccinelle-*-static-ubuntu16.tar.gz
