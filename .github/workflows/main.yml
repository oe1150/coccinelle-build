name: Build Static Coccinelle (musl + GLIBC 2.23 compatible)

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Install Docker and run build
        run: |
          docker run --rm -v $(pwd):/output ubuntu:16.04 bash -c "
            set -ex

            echo 'deb http://archive.ubuntu.com/ubuntu xenial main universe' > /etc/apt/sources.list
            apt-get update
            apt-get install -y \
              build-essential \
              musl-tools \
              ocaml \
              ocaml-native-compilers \
              ocaml-findlib \
              libnum-ocaml-dev \
              libpcre3-dev \
              libpcre-ocaml-dev \
              pkg-config \
              autoconf \
              automake \
              libtool \
              m4 \
              curl \
              wget \
              ca-certificates

            cd /tmp
            wget https://github.com/coccinelle/coccinelle/archive/refs/tags/1.0.7.tar.gz
            tar -xf 1.0.7.tar.gz
            cd coccinelle-1.0.7

            autoreconf -fiv

            CC=musl-gcc ./configure \
              --disable-python \
              --disable-pcre \
              --disable-shared \
              --enable-ocaml \
              --prefix=/opt/spatch-static

            make -j1 LDFLAGS='-static'
            make install

            mkdir -p /output/spatch-release/bin
            cp /opt/spatch-static/bin/spatch /output/spatch-release/bin/
            echo "Coccinelle 1.0.7 static build" > /output/spatch-release/README.txt

            cd /output
            tar -czf spatch-static-1.0.7.tar.gz spatch-release
          "

      - name: Upload release asset
        uses: softprops/action-gh-release@v1
        with:
          tag_name: spatch-1.0.7-static
          name: "Coccinelle 1.0.7 Static (GLIBC 2.23 compatible)"
          body: "This is a static build of Coccinelle 1.0.7 using musl-gcc, compatible with Ubuntu 16.04 (GLIBC 2.23)."
          files: spatch-static-1.0.7.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
