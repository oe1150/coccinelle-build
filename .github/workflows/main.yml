name: Build Static Spatch 1.0.8 (GLIBC 2.23 Compatible)

on:
  workflow_dispatch:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build Coccinelle Native Binary
        run: |
          echo "Starting Docker build for native binary..."
          mkdir -p output

cat > Dockerfile <<'EOF'
FROM ubuntu:16.04

RUN apt-get update && apt-get install -y \
  build-essential \
  ocaml \
  ocaml-native-compilers \
  ocaml-findlib \
  camlp4 \
  libpcre3-dev \
  pkg-config \
  autoconf \
  automake \
  libtool \
  m4 \
  wget \
  curl \
  python-dev \
  python3-dev \
  tcsh \
  csh

WORKDIR /tmp

RUN wget -O coccinelle-1.0.8.tar.gz https://github.com/coccinelle/coccinelle/archive/refs/tags/1.0.8.tar.gz && \
    tar -xzf coccinelle-1.0.8.tar.gz && \
    cd coccinelle-1.0.8 && \
    ./autogen || autoreconf -fiv && \
    ./configure --prefix=/opt/coccinelle \
      --disable-python \
      --disable-pcre \
      --disable-opt \
      --enable-release \
      --without-python \
      --without-pycaml \
      CC="gcc" \
      CXX="g++" \
      PYTHON="no" \
      PYCAML="no" && \
    make spatch.opt && \
    mkdir -p /opt/coccinelle/bin && \
    cp spatch.opt /opt/coccinelle/bin/spatch && \
    chmod +x /opt/coccinelle/bin/spatch && \
    cd /opt && \
    tar -czf /tmp/coccinelle-1.0.8-ubuntu16-binary.tar.gz coccinelle
EOF

          docker build -t coccinelle-builder .
          docker create --name extract coccinelle-builder
          docker cp extract:/tmp/coccinelle-1.0.8-ubuntu16-binary.tar.gz ./output/
          docker rm extract

      - name: Create Release
        if: github.event_name == 'workflow_dispatch' || github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: coccinelle-binary-1.0.8-${{ github.run_number }}
          name: "Coccinelle 1.0.8 Native Binary for Ubuntu 16 (Build ${{ github.run_number }})"
          body: |
            # Coccinelle 1.0.8 Native Binary Build for Ubuntu 16

            ✅ NO TCSH REQUIRED  
            ✅ GLIBC 2.23 Compatible  
            ✅ Native binary works in QSDK builds

            ```bash
            cd ~
            wget https://github.com/${{ github.repository }}/releases/latest/download/coccinelle-1.0.8-ubuntu16-binary.tar.gz
            tar -xzf coccinelle-1.0.8-ubuntu16-binary.tar.gz
            export PATH="$HOME/coccinelle/bin:$PATH"
            echo 'export PATH="$HOME/coccinelle/bin:$PATH"' >> ~/.bashrc
            spatch --version
            ```
          files: output/coccinelle-1.0.8-ubuntu16-binary.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: coccinelle-ubuntu16-binary
          path: output/coccinelle-1.0.8-ubuntu16-binary.tar.gz
          retention-days: 30
